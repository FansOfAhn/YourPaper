<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A layout example that shows off a responsive email layout.">    <title>WOS에서 검색하기</title>    
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css" integrity="sha384-" crossorigin="anonymous">
    
    
    
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="css/layouts/demo-old-ie.css">
        <![endif]-->
        <!--[if gt IE 8]><!-->
            <link rel="stylesheet" href="css/layouts/demo-css.css">
            <link rel="stylesheet" href="css/table.css">
        <!--<![endif]-->
</head>
<body>

<div id="layout" class="content pure-g">
    <div id="nav" class="pure-u">
        <a href="#" class="nav-menu-button">Menu</a>

        <div class="nav-inner">
            <button class="primary-button pure-button">도움말</button>

            <div class="pure-menu">
                <ul class="pure-menu-list">
                    <li class="pure-menu-item"><a href="/member-api.html" class="pure-menu-link">멤버 API</a></li>
                    <li class="pure-menu-item"><a href="/paper-api.html" class="pure-menu-link">페이퍼 API</a></li>
                    <li class="pure-menu-item"><a href="/wos-api.html" class="pure-menu-link">WOS 검색 API</a></li>
                    <li class="pure-menu-heading">메모</li>
                    <li class="pure-menu-item"><a href="#" class="pure-menu-link"><span class="demo-label-personal"></span>노랑</a></li>
                    <li class="pure-menu-item"><a href="#" class="pure-menu-link"><span class="demo-label-work"></span>초록</a></li>
                    <li class="pure-menu-item"><a href="#" class="pure-menu-link"><span class="demo-label-travel"></span>파랑</a></li>
                </ul>
            </div>
        </div>
    </div>


    <div id="main" class="pure-u">
        <div class="demo-content">
            <div class="demo-content-header pure-g">
                <div class="pure-u">
                    <h1 class="demo-content-title">WOS에서 검색하기</h1>
                    <p class="demo-content-subtitle">
                        From <a>김승신</a> at <span>3:10pm, Oct 20, 2019</span>
                    </p>
                </div>

                <div class="demo-content-controls pure-u">
                </div>
            </div>
            
            <div class="demo-content-body">
                <form id="queryForm" class="pure-form">
                    <fieldset>
                        <legend>검색 폼</legend>
                        <select name="category" id="state">
                            <option value="TI">제목</option>
                            <option value="AU">저자</option>
                            <option value="DO">DOI</option>
                        </select>
                        <input id="query" type="text" placeholder="검색어"> <br/>
                        <select name="organization" id="organization">
                            <option value="Sejong Univ">세종대학교</option>
                            <option value="">없음</option>
                        </select>
                        <input id="begin" type="text" placeholder="시작일 yyyy-mm-dd">
                        <input id="end" type="text" placeholder="끝일 yyyy-mm-dd">
                
                        <button type="button" class="pure-button pure-button-primary" onclick="onQuery()">검색</button>
                    </fieldset>
                </form>
                <div>결과 <span id="loading"></span> <span id="result"></span></div>
                <hr/>
                <select name="page-size" id="pageSize" onchange="onPageSizeChange()">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                </select>
                <div id="pagingContainer"></div><br/>
                <table id="contentTable" class="controlled-cell-table">
                    <tr><th>제목</th><th>저자</th><th>인용 수</th><th>발행년월</th><th>볼륨</th><th>페이지</th><th>이슈</th><tr>
                </table>
                <br/>
                <hr/>
                <hr/>
                <div>존재하는 사용자(교수님)에게 논문 추가하기</div>
                <hr/>
                <form id="loginForm" name="login">
                    유저아이디 : <input type="text" name="username"/><br/>
                    논문아이디 : <input type="text" name="uid"/><br/>
                    <button onclick="">추가하기</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="./api/wos-api.js"></script>

<script>
    
    // 검색 클라이언트
    const SERVER_URL = 'http://www.siotman.com:19400/'
    const searchClient = new WokSearchClient(SERVER_URL);

    function onQuery() {
        const loading   = document.getElementById('loading');
        loading.innerHTML = '<font style="color: orange;">loading</font>';

        const queryForm     = document.getElementById("queryForm");
        const pageSize      = Number(document.getElementById("pageSize").value);        

        const category      = queryForm['category'].value;
        const query         = queryForm['query'].value;
        const begin         = queryForm['begin'].value;
        const end           = queryForm['end'].value;
        const organizations = [ queryForm['organization'].value ];
        if (organizations[0] === '') organizations.pop();

        if (query.length < 4) {
            loading.innerHTML = '<font style="color: red">error</font>';
            return alert("검색어가 너무 짧습니다.");
        }
        if (!(new Date(begin))) {
            loading.innerHTML = '<font style="color: red">error</font>';
            return alert("시작 날짜가 비정상적입니다.");
        }
        if (!(new Date(end))) {
            loading.innerHTML = '<font style="color: red">error</font>';
            return alert("끝 날짜가 비정상적입니다.");
        }


        // 이제부터 검색 클라이언트 이벤트 처리 정의
        // 페이지 사이즈를 조정할 수 있음.
        searchClient.setPageSize(pageSize);

        searchClient.setSortField('TC', false);
        /* 1. 인풋 값을 userQuery로 변형하기 */
        console.log('최초 검색 프로세스 :');
        const userQuery = searchClient.buildUserQuery(category, query, organizations);

        // 2. 검색 시작
        searchClient.search(userQuery, begin, end, false, true)
            .then(printSearchResult)
            .catch((error) => {
                console.log('Search, if error :');
                console.log(error);
                searchClient.setLoading(false);
                loading.innerHTML = '<font style="color: red">error</font>';
            });
    }

    function onPageSizeChange() {
        const currentPage = searchClient.getPageState().currentPage;
        if (currentPage === 0) {
            return;
        }
        const pageSize      = Number(document.getElementById("pageSize").value);        

        searchClient.setPageSize(pageSize);
        onPageClick(1);
    }

    function onPageClick(page) {
        loading.innerHTML   = '<font style="color: orange;">loading</font>';

        searchClient.retreive(page)
            .then(printSearchResult)
            .catch(onSearchError);
    }

    function printSearchResult(searchResult) {
                    /* 출력하기 */
                    console.log('출력 단계');
                    const filter    = [3, 4, 7, 8, 9, 11, 12, 13];
                    const headers   = searchClient.getHeaders(filter);
                    const records   = searchClient.getRecords(filter);
                    const result    = document.getElementById('result');
                    const table     = document.getElementById('contentTable');
                    const pages     = document.getElementById('pagingContainer');
                    const pageList  = searchClient.getPageList();

                    result.innerHTML = `찾은 총 레코드 : ${searchResult['recordsFound']}`;
                    pages.innerHTML = `
                            ${pageList.slice(0, 10).map((e) => { 
                                if (e == searchClient.getPageState().currentPage) return ` <span>${e}</span> `;
                                else return ` <a onclick="onPageClick(${e})">${e}</a> `;
                            }).join(' ')}
                    `;
                    let html = `<tr>
                            <th>${headers[0]}</th>
                            <th>${headers[2]}</th>
                            <th>${headers[3]||""}</th>
                            <th>${headers[4]||""}</th>
                            <th>${headers[5]||""}</th>
                            <th>${headers[7]||""}</th>
                            <th>${headers[6]||""}</th>
                        <tr>`;
                    records.forEach(record => {
                        html += `<tr>
                            <td><a href="${record[1]||""}">${record[0]}</a></td>
                            <td>${record[2]}</td>
                            <td>${record[3]||""}</td>
                            <td>${record[4]||""}</td>
                            <td>${record[5]||""}</td>
                            <td>${record[7]||""}</td>
                            <td>${record[6]||""}</td>
                        <tr>`;
                    });
                    table.innerHTML = html;
                    
                    loading.innerHTML = '<font style="color: green;">comleted</font>';
    }

    function onSearchError(error) {
        const loading   = document.getElementById('loading');

        console.log('Search, if error :');
        console.log(error);
        searchClient.setLoading(false);
        loading.innerHTML = '<font style="color: red">error</font>';
    }
</script>


<script src="https://yui-s.yahooapis.com/3.18.1/build/yui/yui-min.js"></script><script>
    YUI().use('node-base', 'node-event-delegate', function (Y) {
        var menuButton = Y.one('.nav-menu-button'),
            nav        = Y.one('#nav');
        menuButton.on('click', function (e) {
            nav.toggleClass('active');
        });
    });
</script>
</body>
</html>