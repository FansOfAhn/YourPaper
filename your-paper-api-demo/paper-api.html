<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A layout example that shows off a responsive email layout.">    <title>주 데이터베이스에서 검색하기</title>    
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css" integrity="sha384-" crossorigin="anonymous">
    
    
    
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="css/layouts/demo-old-ie.css">
        <![endif]-->
        <!--[if gt IE 8]><!-->
            <link rel="stylesheet" href="css/layouts/demo-css.css">
            <link rel="stylesheet" href="css/table.css">
        <!--<![endif]-->
</head>
<body>

<div id="layout" class="content pure-g">
    <div id="nav" class="pure-u">
        <a href="#" class="nav-menu-button">Menu</a>

        <div class="nav-inner">
            <button class="primary-button pure-button">도움말</button>

            <div class="pure-menu">
                <ul class="pure-menu-list">
                    <li class="pure-menu-item"><a href="/member-api.html" class="pure-menu-link">멤버 API</a></li>
                    <li class="pure-menu-item"><a href="/paper-api.html" class="pure-menu-link">페이퍼 API</a></li>
                    <li class="pure-menu-item"><a href="/wos-api.html" class="pure-menu-link">WOS 검색 API</a></li>
                    <li class="pure-menu-heading">메모</li>
                    <li class="pure-menu-item"><a href="#" class="pure-menu-link"><span class="demo-label-personal"></span>노랑</a></li>
                    <li class="pure-menu-item"><a href="#" class="pure-menu-link"><span class="demo-label-work"></span>초록</a></li>
                    <li class="pure-menu-item"><a href="#" class="pure-menu-link"><span class="demo-label-travel"></span>파랑</a></li>
                </ul>
            </div>
        </div>
    </div>


    <div id="main" class="pure-u">
        <div class="demo-content">
            <div class="demo-content-header pure-g">
                <div class="pure-u">
                    <h1 class="demo-content-title">주 데이터베이스에서 사용자 아이디로 검색하기</h1>
                    <p class="demo-content-subtitle">
                        From <a>김승신</a> at <span>3:10pm, Oct 20, 2019</span>
                    </p>
                </div>

                <div class="demo-content-controls pure-u">
                </div>
            </div>
            
            <div class="demo-content-body">
                <form id="queryForm" class="pure-form">
                    <fieldset>
                        <legend>검색 폼</legend>
                        <select name="category" id="state">
                            <option value="title">제목</option>
                            <option value="authorListJson">저자</option>
                            <option value="doi">DOI</option>
                            <option value="username">직번</option>
                        </select>
                        <input id="query" type="text" placeholder="검색어">
                        <button type="button" class="pure-button pure-button-primary" onclick="onQuery(0)">검색</button>
                    </fieldset>
                </form>
                <div>결과 <span id="loading"></span> <span id="result"></span></div>
                <hr/>
                <select name="page-size" id="pageSize" onchange="onPageSizeChange()">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                </select>
                <div id="pagingContainer"></div><br/>
                <table id="contentTable" class="controlled-cell-table">
                    <tr><th>제목</th><th>저자</th><th>인용 수</th><th>발행년월</th><th>볼륨</th><th>페이지</th><th>이슈</th><tr>
                </table>
                <br/>
                <hr/>
                <input id="uid" type="text", placeholder="uid">
                <button type="button" class="pure-button-primary" onclick="addOne()">추가</button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="./api/wos-api.js"></script>
<script src="./api/paper-api.js"></script>

<script>
    let pageList = [];
    let pageStart = 0;
    const pageState = {
        page: 0,
        total: 0,
        totalPages: 0,
        pageList: [],
        pageListStart: 0,
    };
    let records = [];
    // 검색 클라이언트
    // const SERVER_URL = 'http://www.siotman.com:19401/'
    const SERVER_URL = 'http://localhost:9401/'
    
    let paperContainer = new PaperRecordContainer('data5000', `Basic ${btoa(`${'data5000'}:${'data5000'}`)}`, SERVER_URL);

    function addOne() {
        const uid = document.getElementById('uid').value;
        paperContainer.addOrUpdateOne(uid).then(res => {
            console.log('DELETE ONE', res);
        }).catch(error => {
            console.error('DELETE ONE ERROR', error);
        })
    }

    function deleteOne(uid) {
        alert("DELETE ONE");
        paperContainer.deleteOne(uid).then(res => {
            console.log('DELETE ONE', res);
        }).catch(error => {
            console.error('DELETE ONE ERROR', error);
        })
    }

    function onQuery(page) {
        const loading   = document.getElementById('loading');
        loading.innerHTML = '<font style="color: orange;">loading</font>';

        const queryForm     = document.getElementById("queryForm");
        const pageSize      = Number(document.getElementById("pageSize").value);        

        const category      = queryForm['category'].value;
        const query         = queryForm['query'].value;
        
        if (query.length < 3) {
            loading.innerHTML = '<font style="color: red">error</font>';
            return alert("검색어가 너무 짧습니다.");
        }
        if (category === 'username') {
            paperContainer.username = query;
            paperContainer.listByPage(page, pageSize, SORT_MP_ENUM.TITLE, true)
            .then(res => {
                if (page == 0) {
                    pageList = [];
                    pageStart = 0;
                }
                for(let i = 0; i < res['totalPages']; i++) {
                    pageList.push(i);
                }
                return res;
            }).then(printSearchResult)
            .catch(onSearchError);
        } else {
            paperContainer.usernae = 'data5000';
            paperContainer.search(page, pageSize, SORT_P_ENUM.TITLE, true, category, query)
            .then(res => {
                if (page == 0) {
                    pageList = [];
                    pageStart = 0;
                }
                for(let i = 0; i < res['totalPages']; i++) {
                    pageList.push(i);
                }
                return res;
            }).then(printSearchResult)
            .catch(onSearchError);
        }
    }

    function onPageSizeChange() {
        const currentPage = pageState.page;
        if (currentPage === 0) {
            return;
        }
        onPageClick(0);
    }

    function onPageClick(page) {
        loading.innerHTML   = '<font style="color: orange;">loading</font>';
        onQuery(page);
    }

    function pageStepClick(step) {
        if (step > 0) {
            pageStart += 10;
        } else {
            pageStart -= 10;
        }
        onQuery(pageStart);
    }
    function printSearchResult(resultPage) {
        /* 출력하기 */
        console.log('출력 단계');
        console.log(resultPage);
        
        records   = resultPage['content'];
        const result    = document.getElementById('result');
        const table     = document.getElementById('contentTable');
        const pages     = document.getElementById('pagingContainer');

        const nowPage   = resultPage['pageable']['pageNumber'];
        console.log(records);
        
        result.innerHTML = `찾은 총 레코드 : ${resultPage['totalElements']}`;
        
        pages.innerHTML = `
                ${(() => { if (pageStart > 0) return `<span onclick="pageStepClick(-1)"> 이전 </span>`; })() || ''}
                ${pageList.slice(pageStart, pageStart + 10).map((e) => { 
                    if (e == nowPage) return ` <span>${e + 1}</span> `;
                    else return ` <a onclick="onPageClick(${e})">${e + 1}</a> `;
                }).join(' ')}
                ${(() => { if (nowPage + 1 < resultPage['totalPages']) return `<span onclick="pageStepClick(1)"> 다음 </span>`; })() || ''}

        `;
        [
        //      0    1      2      3     4
                '행', 'UID', 'DOI', '제목', '링크',
        //      5        6          7      8
                '교신저자', '저자 상태', '저자', '인용수',
        //      9        10      11   12    13
                '발행년월', '저녈명', '권', '호', '페이지',
        //      14        15     16    17       18
                '월별피인용', '등급', 'IF', '백분율', '파싱 상태',
        //      19      20      21
                'issn', 'isbn', 'eissn'
            ]
        const filter = [1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21];
        let html = `<tr>
                <th>삭제버튼</th>
                ${paperContainer.getHeaders(filter).map(e => {
                    return `<th>${e}</th>`;
                }).join('')}
            <tr>`;
        paperContainer.getRecords(filter).forEach((record, idx) => {
            html += `<tr>
                <td onclick="deleteOne('${record[0]}')">삭제</td>
                ${record.map(e => {
                    return `<td>${e}</td>`;
                }).join('')}
            <tr>`;
        });
        table.innerHTML = html;
        loading.innerHTML = '<font style="color: green;">comleted</font>';
    }

    function popUpTcData(idx) {
        if (!records[idx]['parsedData']) return alert('파싱된 데이터가 없음');
        const tcData = records[idx]['parsedData']['tcDataJson'];
        const message = `${Object.keys(tcData).map(year => {
                let none = tcData[year][year];
                if (none) delete tcData[year][year];
                let byMonth = Object.keys(tcData[year]).map(month => {
                    return `${month} : ${tcData[year][month]}`;
                }).join(' | ');
                if (none) byMonth += ' | noMonth : ' + none;
                none = '';
                return `${year} : ${byMonth}`;
            }).join('\n')}
        `;
        alert(message);
    }
    function onSearchError(error) {
        const loading   = document.getElementById('loading');

        console.log('Search, if error :');
        console.log(error);
        loading.innerHTML = '<font style="color: red">error</font>';
    }
</script>


<script src="https://yui-s.yahooapis.com/3.18.1/build/yui/yui-min.js"></script><script>
    YUI().use('node-base', 'node-event-delegate', function (Y) {
        var menuButton = Y.one('.nav-menu-button'),
            nav        = Y.one('#nav');
        menuButton.on('click', function (e) {
            nav.toggleClass('active');
        });
    });
</script>
</body>
</html>